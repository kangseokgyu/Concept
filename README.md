# Blockchain

## Block

블록이란 **유효한 정보의 묶음**이다.

비트코인의 경우, 블록은 유효한 거래 정보의 묶음이며, 약 2300개의 거래 정보가 포함되어 있다.

블록은 **블록 헤더**, **정보**, **기타 정보**로 구성된다.

### Block Header

블록 헤더는 version, previous block hash, merkle hash, timestamp, bits, nonce로 구성된다.

1. version : 소프트웨어/프로토콜 버전
2. previous block hash : 블록 체인에서 이전 블록의 해쉬
3. merkle hash : 개별 정보의 해쉬를 2진 트리 형태로 구성할 때, 트리 루트의 해쉬
4. timestamp : 블록이 생성된 시간
5. bits : 블록 생성 시 난이도 조절 수치
6. nonce : 0부터 1씩 증가시켜 난이도를 만족하는 해쉬값을 찾기 위한 수치

### Block Hash

블록 해쉬는 **블록의 유효성을 검증**하는 값이다.
블록 헤더의 6 가지 정보를 입력 값으로 구해진다.
블록 전체 값의 해쉬가 아니라 **블록 헤더의 값만** 입력 값으로 사용한다.

## Blockchain

블록 체인은 블록이 이어져 만들어진 **블록의 집합체**이다.
previous block hash를 통해 블록들은 체인을 이루게된다.

## Proof of Work

작업 증명은 새로운 블록이 생성되어 블록 체인에 추가되기위한 작업이다. 이를 채굴 작업이라고도 한다.
새로운 블록이 블록 체인에 추가되기 위해서는 난이도 조절 수치인 bits를 만족시키는 nonce를 찾는 작업이 필요하다.
bits는 block header의 해쉬인 block hash의 값이 일정 수치 이하의 값을 가지도록하는 기준이되고, block header의 6가지 값 중 5가지는 고정된 값을 가지며 nonce만 0부터 1씩 증가시켜 이를 만족시키는 block hash를 찾는 작업을 진행하게된다.

## 작업 난이도

작업 난이도는 **nonce 값을 계산의 어려운 정도**를 나타내며, bits 값으로 조절된다.

Block hash가 SHA256을 사용한다면, 0 ~ (2^256) - 1의 값을 가지게되고 bits를 통해 2^255 보다 작은 값을 가지도록 한다면 2^255 / 2^256 = 50%의 확률로 block hash 값을 계산해 낼 수 있다.

bits 값은 지수와 계수를 사용하는 별도의 표현 방식을 사용한다.

## 보상

작업 증명은 해쉬 연산을 필요로하기 때문에, 블록에 대한 첫번째 채굴자에게 보상이 주어진다.
비트코인의 경우, 블록에 포함된 거래의 수수료와 새로 발행되는 비트코인이 보상으로 주어지게된다.

## 충돌 해소

### 거래 정보의 전파

블록 체인은 거대한 분산 공개 장부이다. 이 분산 공개 장부는 여러 개의 노드에 복사되어 있으며, 노드들은 p2p로 연결되어 블록 체인 네트워크를 형성한다. 하나의 유효 정보가 발생하면 이 유효 정보는 블록 체인 네트워크에 의해 노드들에게 전파된다.

### 블록의 생성 및 전파

블록에 유효 정보가 채워지면 노드는 블록을 생성한다.
새로 만들어진 블록은 현재 마지막 블록 다음에 추가된다.
채굴자에 의해 nonce를 찾은 블록은 인접 노드들에게 전파되고, 인접 노드에서는 전달받은 블록의 block hash를 다시 계산하여 유효한 블록인지 검증 후 자신이 가지고 있던 블록 체인에 추가한다.

### 블록 체인의 분기

노드 간 거리 차로 인하여 유효 정보의 순서가 바뀔 수 있고, 순서가 바뀔 경우 block header는 다른 값을 가지게 된다. 이럴 경우 서로 다른 두 개의 블록이 현재 마지막 블록 다음에 추가될 수 있다. 이를 블록 체인의 분기라고 한다. 블록 체인의 분기가 일어나 충돌이 발생할 경우, 분기가 일어난 블록들 중 더 많은 작업 증명이 수행된 블록을 선택하게 된다.

블록 생성은 약 10분이 소요될 정도로 연산량이 큰 작업이며, 따라서 블록 체인의 분기가 발생할 가능성은 그리 높지 않다. 또한 분기가 발생하더라도 머지않아 블록 체인의 길이가 달라져 분기에 의한 충돌은 해소된다.

만약, 분기가 일어난 블록 중 버려진 블록의 유효 정보가 유실되지 않을까? 생각할 수 있다. 하지만 유실된 블록의 유효 정보가 선택된 블록 체인에 포함되어 있지 않다면, 후보 블록에 유효 정보가 포함되게 된다.

## 블록 체인의 무결성

유효 정보는 디지털 서명을 통해 무결성이 보장되고 merkle hash의 입력 값이다. merkle hash는 block hash의 입력 값으로 사용된다.
어떤 유효 정보가 변경되면 그에 맞는 디지털 서명이 변경되고, merkle hash가 변경되고, 이어 block hash까지 변경되게 된다.
블록 체인 중간의 한 유효 정보가 변경된다면 그 블록의 block hash만 변경될 뿐아니라 이후의 모든 블록의 block hash가 변경된다.
악의적으로 공격자가 유효 정보를 변경한다거나 블록 간의 순서를 변경한다면, 해당 블록 이후의 모든 블록의 작업 증명을 새로해야 한다.

## Proof of Stake

지분증명방식 (PoS)은 보통 부정적인 외부 영향 혹은 작업증명방식 (PoW) 기반 시스템에 내재된 문제를 해결하거나 완화하기 위한 대안으로 

## 블록체인의 종류

|                  | Public Blockchian                               | Private(Consortium) Blockchain                                  |
|------------------|-------------------------------------------------|-----------------------------------------------------------------|
| 읽기 권한         | 누구나 열람 가능                                 | 허가된 기관만 열람 가능                                           |
| 거래 검증 및 승인 | 누구나 네트워크에 참여하면 거래 검증 및 승인을 수행 | 승인된 기관과 감독 기관                                           |
| 트랜잭션 생성자   | 누구나 트랜잭션을 생성                            | 법적 책임을 지는 기관만 참여                                      |
| 합의 알고리즘     | 부분 분기를 허용하는 작업증명이나 지분증명 알고리즘 | 부분분기를 허용하지 않는 BFT계열의 합의 알고리즘                    |
| 속도             | 7~20 TPS                                        | 1000 TPS 이상의 고성능                                           |
| 권한 관리         | 누구나 모두가 모든 일을 할 수 있음                | Private Channel, Tierd System 등을 통해 읽기 쓰기 권한 관리가 가능 |
| 예시             | 비트코인, 이더리움                                | IBM Fabric, LoopChain, R3 Corda                                 |

- Public Blockchain : 비트코인, 이더리움과 같은 누구나 네트워크에 참여할 수 있는 블록체인
- Private Blockchain : 하나의 기관에서 독자적으로 사용하는 블록체인
- Consortium Blockchain : 여러 기관들이 컨소시움을 이뤄 구성하는 블록체인. 허가된 기관만 네트워크에 참여할 수 있다.

### Public Blockchain

악의적인 목적을 가진 해커도 데이터에 접근할 수 있고, 악의적인 네트워크 참여자의 공격을 방어하면서 세계 각지의 모든 노드들이 같은 데이터를 공유해야 한다. 이러한 요구사항을 만족시켜야 하기 때문에 성능 면에서 불리하다.

Public Blockchain에서는 누구나 블록 후보를 만들어 제출하고 분산합의를 통해 하나의 블록을 선정해 신뢰할 수 있는 블록으로 인정받는 구조이다. 따라서 인터넷 상에서 블록을 공유해야 하는 시간이 있고 너무 많은 블록이 동시에 만들어지면 하나의 블록을 선택하기 어렵기 때문에 블록 생성시간에 제한을 두고 있다. 비트코인의 경우 약 10분마다 하나의 블록을 생성하고, 이더리움의 경우 약 12초마다 하나의 블록을 생성한다. 네트워크에 공유되는 시간을 고려했을 때 이더리움에서 내가 보낸 트랙잭션 결과를 확인하려면 1-2분 정도 기다려야 한다. 즉각적인 처리가 필요한 금융권 서비스에서 그대로 적용하기에는 불가능한 수준이다.

Public Blockchain에서 채택하는 분산합의 알고리즘으로 작업증명(Proof of Work, PoW)이나 지분증명(Proof of Stake, PoS)을 사용하려면 내부 화폐가 필요하다. Public Blockchain에서 분산합의 목표는 결국 거래 내역을 검증해 신뢰할 수 있는 블록을 만들수 있는 노드를 선택하는 것이고, 이러한 수고를 하는 대가가 필요기 때문이다. 작업 증명의 경우는 쓸모없는 컴퓨팅 파워를 많이 사용하기 때문에 친환경적이지 않은 문제도 있다.

### Private Blockchain

Public Blockchain에서 사용하는 알고리즘들은 나중에 블록 생성 후 블록이 확정되기 때문에 허용되는 시간 안에 네트워크 분기가 생길 수 있어, 항상 확실한 데이터를 보장해야 하는 금융권에는 적합하지 않다. 때문에 Private(Consortium) Blockchain들은 비잔티움 장애 허용(Byzantine Fault Tolerance) 계열의 분산합의 알고리즘을 사용해 네트워크 분기를 허용하지 않는다.

### hyperledger

IBM 주도로 개발 중인 Private Blockchain.
퍼포먼스가 장점.
이유는 PoW 합의의 비트코인, 이더리움에 비해 합의로직이 빠르다.
레져기반이기 때문에 블록체인 기반의 비트코인에 비해 애플리케이션 개발이 쉽다.
블록체인 기반은 안의 로직을 다 알아야하기 때문에 개발이 어렵지만 레져기반에서는 개발이 쉽다.
삼성 SDS가 블록체인 프로젝트를 많이 진행 중.
데이터의 프라이버시가 중요하다.
데이터가 허용되어야 할 대상이 있기때문에 허용된 사람에게만 보여줘야한다.

- 비잔틴 장군 프로블럼

2/3 합의점.

비잔티움 장군 문제는 레슬리 램포트와 쇼스탁, 피스가 공저한 1982년 논문에서 처음 언급됐다. 이 논문에서 저자들은 적군의 도시를 공격하려는 비잔티움 제국군의 여러 부대가 지리적으로 떨어진 상태에서 각 부대의 장군들이 (중간에 잡힐지도 모르는) 전령을 통해 교신하면서 공격 계획을 함께 세우는 상황을 가정하고 있다.

충직한 장군들은 합의된 규칙을 충실하게 따르며 이 외의 행동은 하지 않는다. 그러나 전체 장군 중 일부는 배신자일 수 있으며, 배신자는 규칙에 얽매이지 않고 마음대로 행동할 수 있다. 이 때 배신자의 존재에도 불구하고 충직한 장군들이 동일한 공격 계획을 세우기 위해서는 충직한 장군들의 수가 얼마나 있어야 하며, 장군들이 어떤 규칙을 따라 교신해야 하는지에 대한 문제가 비잔티움 장군 문제다.

사실 계획이 합리적인지도 판단한다면 더 좋으나, 이는 판단할 수 없으므로 포기하고, 오직 다수의 합의를 이끌어내는 것에만 초점을 맞춘다.

보장해야 하는 것은 아래와 같다.

1. 모든 충직한 장군들은, 같은 정보를 획득해야 한다. (누가 배신자인지 모르기 때문에, x번째 장군이 직접 보낸 메시지를 받았다 하더라도, 바로 사용할 수 없다.)
2. 만약 n번째 장군이 충직하다면, n번째 장군이 보낸 값은 충직한 장군들한테 같게 보내져야 한다.

- 카우치 DB

- IOTA

IOT에서 사용할 블록체인. 수많은 센서에서 들어오는 정보를 처리하기 위한.

- MOBI

자동차업계의 Blockchain.
자동차 센서의 모든 데이터를 IOTA로 저장.
모든 데이터를 블록체인에 넣으면 해킹으로부터 방어가 가능하다.
데이터들을 가지고 새로운 비즈니스를 창출할 수 있다.
블록체인을 사용하면 모든 데이터를 업계가 공동으로 가지고있을 수 있다.

- maersk 해운 물류 블록체인

## 참고자료 
  1. https://homoefficio.github.io/2017/11/19/%EB%B8%94%EB%A1%9D%EC%B2%B4%EC%9D%B8-%ED%95%9C-%EB%B2%88%EC%97%90-%EC%9D%B4%ED%95%B4%ED%95%98%EA%B8%B0/
  2. https://www.youtube.com/watch?time_continue=2&v=bBC-nXj3Ng4
  3. https://www.blockchain.com/charts
  4. http://www.bloter.net/archives/273344

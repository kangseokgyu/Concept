# Blockchain

## Block

블록이란 **유효한 정보의 묶음**이다.

비트코인의 경우, 블록은 유효한 거래 정보의 묶음이며, 약 2300개의 거래 정보가 포함되어 있다.

블록은 **블록 헤더**, **정보**, **기타 정보**로 구성된다.

### Block Header

블록 헤더는 version, previous block hash, merkle hash, timestamp, bits, nonce로 구성된다.

1. version : 소프트웨어/프로토콜 버전
2. previous block hash : 블록 체인에서 이전 블록의 해쉬
3. merkle hash : 개별 정보의 해쉬를 2진 트리 형태로 구성할 때, 트리 루트의 해쉬
4. timestamp : 블록이 생성된 시간
5. bits : 블록 생성 시 난이도 조절 수치
6. nonce : 0부터 1씩 증가시켜 난이도를 만족하는 해쉬값을 찾기 위한 수치

### Block Hash

블록 해쉬는 **블록의 유효성을 검증**하는 값이다.
블록 헤더의 6 가지 정보를 입력 값으로 구해진다.
블록 전체 값의 해쉬가 아니라 **블록 헤더의 값만** 입력 값으로 사용한다.

## Blockchain

블록 체인은 블록이 이어져 만들어진 **블록의 집합체**이다.
previous block hash를 통해 블록들은 체인을 이루게된다.

## Proof of Work

작업 증명은 새로운 블록이 생성되어 블록 체인에 추가되기위한 작업이다. 이를 채굴 작업이라고도 한다.
새로운 블록이 블록 체인에 추가되기 위해서는 난이도 조절 수치인 bits를 만족시키는 nonce를 찾는 작업이 필요하다.
bits는 block header의 해쉬인 block hash의 값이 일정 수치 이하의 값을 가지도록하는 기준이되고, block header의 6가지 값 중 5가지는 고정된 값을 가지며 nonce만 0부터 1씩 증가시켜 이를 만족시키는 block hash를 찾는 작업을 진행하게된다.

## 작업 난이도

작업 난이도는 **nonce 값을 계산의 어려운 정도**를 나타내며, bits 값으로 조절된다.

Block hash가 SHA256을 사용한다면, 0 ~ (2^256) - 1의 값을 가지게되고 bits를 통해 2^255 보다 작은 값을 가지도록 한다면 2^255 / 2^256 = 50%의 확률로 block hash 값을 계산해 낼 수 있다.

bits 값은 지수와 계수를 사용하는 별도의 표현 방식을 사용한다.

## 보상

작업 증명은 해쉬 연산을 필요로하기 때문에, 블록에 대한 첫번째 채굴자에게 보상이 주어진다.
비트코인의 경우, 블록에 포함된 거래의 수수료와 새로 발행되는 비트코인이 보상으로 주어지게된다.

## 충돌 해소

### 거래 정보의 전파

블록 체인은 거대한 분산 공개 장부이다. 이 분산 공개 장부는 여러 개의 노드에 복사되어 있으며, 노드들은 p2p로 연결되어 블록 체인 네트워크를 형성한다. 하나의 유효 정보가 발생하면 이 유효 정보는 블록 체인 네트워크에 의해 노드들에게 전파된다.

### 블록의 생성 및 전파

블록에 유효 정보가 채워지면 노드는 블록을 생성한다.
새로 만들어진 블록은 현재 마지막 블록 다음에 추가된다.
채굴자에 의해 nonce를 찾은 블록은 인접 노드들에게 전파되고, 인접 노드에서는 전달받은 블록의 block hash를 다시 계산하여 유효한 블록인지 검증 후 자신이 가지고 있던 블록 체인에 추가한다.

### 블록 체인의 분기

노드 간 거리 차로 인하여 유효 정보의 순서가 바뀔 수 있고, 순서가 바뀔 경우 block header는 다른 값을 가지게 된다. 이럴 경우 서로 다른 두 개의 블록이 현재 마지막 블록 다음에 추가될 수 있다. 이를 블록 체인의 분기라고 한다. 블록 체인의 분기가 일어나 충돌이 발생할 경우, 분기가 일어난 블록들 중 더 많은 작업 증명이 수행된 블록을 선택하게 된다.

블록 생성은 약 10분이 소요될 정도로 연산량이 큰 작업이며, 따라서 블록 체인의 분기가 발생할 가능성은 그리 높지 않다. 또한 분기가 발생하더라도 머지않아 블록 체인의 길이가 달라져 분기에 의한 충돌은 해소된다.

만약, 분기가 일어난 블록 중 버려진 블록의 유효 정보가 유실되지 않을까? 생각할 수 있다. 하지만 유실된 블록의 유효 정보가 선택된 블록 체인에 포함되어 있지 않다면, 후보 블록에 유효 정보가 포함되게 된다.

## 블록 체인의 무결성

유효 정보는 디지털 서명을 통해 무결성이 보장되고 merkle hash의 입력 값이다. merkle hash는 block hash의 입력 값으로 사용된다.
어떤 유효 정보가 변경되면 그에 맞는 디지털 서명이 변경되고, merkle hash가 변경되고, 이어 block hash까지 변경되게 된다.
블록 체인 중간의 한 유효 정보가 변경된다면 그 블록의 block hash만 변경될 뿐아니라 이후의 모든 블록의 block hash가 변경된다.
악의적으로 공격자가 유효 정보를 변경한다거나 블록 간의 순서를 변경한다면, 해당 블록 이후의 모든 블록의 작업 증명을 새로해야 한다.

## 참고자료 
  1. https://homoefficio.github.io/2017/11/19/%EB%B8%94%EB%A1%9D%EC%B2%B4%EC%9D%B8-%ED%95%9C-%EB%B2%88%EC%97%90-%EC%9D%B4%ED%95%B4%ED%95%98%EA%B8%B0/
  2. https://www.youtube.com/watch?time_continue=2&v=bBC-nXj3Ng4
  3. https://www.blockchain.com/charts
